<!DOCTYPE html>

<html>
<head>
  <title>kibitzer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>kibitzer.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>TODO I suppose my attitude is to use an event emitter very sparingly, because
I want to use one to emit Kibitzer events, the paxos log, but I don’t want to
create an interface that looks like one of the EventEmitter heavy interfaces.</p>
<p>One of the challenges here is that events are going to flow immediately,
unless I do something compliacated like only emit events when there is a
listener. Having looked at that, it is not actually that complicated.</p>
<p>Now we can fuss about some terminate logic.</p>
<p>Put it out again, I prefer to program with error-first callbacks, but events
happen. They are generally a way in which information enters the system. They
are synchronous. Here is more information. Generally, they shouldn’t block.</p>
<p>That’s how I use EventEmitters, but I’m not in for a penny, in for a pound.
If there is a source of events, I treat that as a stream of events. Not in
the Node.js streams sense, but I create an event emitter that emits a
homogenous series of events terminated by a specific termination event.</p>
<p>Then I stop. I don’t go on to implement multi-interfaces that could take an
error-first callback, or maybe register an event handler, or maybe use some
other form of asynchronous notification.</p>
<p>TODO Which is why I’ve made the event emitter in this class a separate
object. Which is such a good idea, I belive I’ll go and do it Happenstance.</p>
<p>TODO Here I am, back to remove the EventEmitter. Not sure how anyone is able
to program that way, treating everything in your application as a stream.
Pushing log entires as events, hard to reason about this firehose events, and
it makes any asynchronous calls in response to an event require subsequent
queuing of events, so why not use this queue that already exists?</p>

            </div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Quality control.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)

</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>EventEmitter API.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>)
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
<span class="hljs-keyword">var</span> departure = <span class="hljs-built_in">require</span>(<span class="hljs-string">'departure'</span>)

</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Common utiltieis.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
<span class="hljs-keyword">var</span> nop = <span class="hljs-built_in">require</span>(<span class="hljs-string">'nop'</span>)

</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Control-flow libraries.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> abend = <span class="hljs-built_in">require</span>(<span class="hljs-string">'abend'</span>)
<span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)
<span class="hljs-keyword">var</span> Timer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'happenstance'</span>).Timer
<span class="hljs-keyword">var</span> Procession = <span class="hljs-built_in">require</span>(<span class="hljs-string">'procession'</span>)

</pre></div></div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Paxos libraries.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Paxos = <span class="hljs-built_in">require</span>(<span class="hljs-string">'paxos'</span>)
<span class="hljs-keyword">var</span> Islander = <span class="hljs-built_in">require</span>(<span class="hljs-string">'islander'</span>)
<span class="hljs-keyword">var</span> Monotonic = <span class="hljs-built_in">require</span>(<span class="hljs-string">'monotonic'</span>).asString

</pre></div></div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Construction notification and destruction.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Destructible = <span class="hljs-built_in">require</span>(<span class="hljs-string">'destructible'</span>)
<span class="hljs-keyword">var</span> Signal = <span class="hljs-built_in">require</span>(<span class="hljs-string">'signal'</span>)

</pre></div></div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Logging.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'prolific.logger'</span>).createLogger(<span class="hljs-string">'kibitz'</span>)

</pre></div></div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Message queue.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Caller = <span class="hljs-built_in">require</span>(<span class="hljs-string">'conduit/caller'</span>)

</pre></div></div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Catch exceptions based on a regex match of an error message or property.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> rescue = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rescue'</span>)

</pre></div></div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>The <code>Kibitzer</code> object contains an islander, which will submit messages to
Paxos, track the log generated by Paxos and resubit any messages that might
have been dropped.</p>

            </div>

        </li>


        <li id="section-12">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Kibitzer</span> (<span class="hljs-params">options</span>) </span>{
</pre></div></div>

        </li>


        <li id="section-13">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Log used to drain Islander.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.log = <span class="hljs-keyword">new</span> Procession

</pre></div></div>

        </li>


        <li id="section-14">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>These defaults are a bit harsh if you’re going to log everything.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    options.ping || (options.ping = <span class="hljs-number">250</span>)
    options.timeout || (options.timeout = <span class="hljs-number">1000</span>)

</pre></div></div>

        </li>


        <li id="section-15">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Time obtained from optional <code>Date</code> for unit testing.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._Date = options.Date || <span class="hljs-built_in">Date</span>

    <span class="hljs-keyword">this</span>.paxos = <span class="hljs-keyword">new</span> Paxos(<span class="hljs-keyword">this</span>._Date.now(), <span class="hljs-literal">null</span>, options.id, {
        <span class="hljs-attr">ping</span>: options.ping,
        <span class="hljs-attr">timeout</span>: options.timeout
    })

</pre></div></div>

        </li>


        <li id="section-16">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Submission queue with resubmission logic.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.islander = <span class="hljs-keyword">new</span> Islander(options.id)

</pre></div></div>

        </li>


        <li id="section-17">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Copy messages from the Paxos log to our log.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.paxos.log.shifter().pump(<span class="hljs-keyword">this</span>.log, <span class="hljs-string">'enqueue'</span>)

</pre></div></div>

        </li>


        <li id="section-18">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Paxos also sends messages to Islander for accounting.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.paxos.log.shifter().pump(<span class="hljs-keyword">this</span>.islander, <span class="hljs-string">'enqueue'</span>)

    <span class="hljs-keyword">this</span>._shifters = <span class="hljs-literal">null</span>

</pre></div></div>

        </li>


        <li id="section-19">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Caller to make network requests.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._caller = <span class="hljs-keyword">new</span> Caller

    <span class="hljs-keyword">this</span>.read = <span class="hljs-keyword">this</span>._caller.read
    <span class="hljs-keyword">this</span>.write = <span class="hljs-keyword">this</span>._caller.write

    <span class="hljs-keyword">this</span>.played = <span class="hljs-keyword">new</span> Procession


    <span class="hljs-keyword">this</span>._destructible = <span class="hljs-keyword">new</span> Destructible(<span class="hljs-number">1000</span>, <span class="hljs-string">'kibitzer'</span>)
    <span class="hljs-keyword">this</span>._destructible.markDestroyed(<span class="hljs-keyword">this</span>, <span class="hljs-string">'destroyed'</span>)

    <span class="hljs-keyword">this</span>._shifters = {
        <span class="hljs-attr">paxos</span>: <span class="hljs-keyword">this</span>.paxos.outbox.shifter(),
        <span class="hljs-attr">islander</span>: <span class="hljs-keyword">this</span>.islander.outbox.shifter()
    }

    <span class="hljs-keyword">this</span>._destructible.addDestructor(<span class="hljs-string">'publish'</span>, <span class="hljs-keyword">this</span>._shifters.islander, <span class="hljs-string">'destroy'</span>)
    <span class="hljs-keyword">this</span>._destructible.addDestructor(<span class="hljs-string">'send'</span>, <span class="hljs-keyword">this</span>._shifters.paxos, <span class="hljs-string">'destroy'</span>)

    <span class="hljs-keyword">this</span>._destructible.addDestructor(<span class="hljs-string">'scheduler'</span>, <span class="hljs-keyword">this</span>.paxos.scheduler, <span class="hljs-string">'clear'</span>)
    <span class="hljs-keyword">this</span>._destructible.addDestructor(<span class="hljs-string">'eos'</span>, <span class="hljs-keyword">this</span>.write, <span class="hljs-string">'push'</span>)

    <span class="hljs-keyword">this</span>.destruction = <span class="hljs-keyword">this</span>._destructible.events

    <span class="hljs-keyword">this</span>.ready = <span class="hljs-keyword">new</span> Signal
}

Kibitzer.prototype.listen = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
</pre></div></div>

        </li>


        <li id="section-20">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>TODO Pass an “operation” to <code>Procession.pump</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> timer = <span class="hljs-keyword">new</span> Timer(<span class="hljs-keyword">this</span>.paxos.scheduler)
    timer.events.shifter().pump(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">envelope</span>) </span>{
        logger.info(<span class="hljs-string">'timer'</span>, envelope)
        <span class="hljs-keyword">this</span>.play(<span class="hljs-string">'event'</span>, envelope)
    }.bind(<span class="hljs-keyword">this</span>))
    <span class="hljs-keyword">this</span>.paxos.scheduler.events.shifter().pump(timer, <span class="hljs-string">'enqueue'</span>)
    <span class="hljs-keyword">this</span>._publish(<span class="hljs-keyword">this</span>._destructible.monitor(<span class="hljs-string">'publish'</span>))
    <span class="hljs-keyword">this</span>._send(<span class="hljs-keyword">this</span>._destructible.monitor(<span class="hljs-string">'send'</span>))
    <span class="hljs-keyword">this</span>.ready.unlatch()
    <span class="hljs-keyword">this</span>._destructible.completed.wait(<span class="hljs-keyword">async</span>())
})

</pre></div></div>

        </li>


        <li id="section-21">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>You can just as easily use POSIX time for the <code>republic</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype.bootstrap = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">republic, properties</span>) </span>{
    assert(republic != <span class="hljs-literal">null</span>)
    <span class="hljs-keyword">this</span>.play(<span class="hljs-string">'bootstrap'</span>, { <span class="hljs-attr">republic</span>: republic, <span class="hljs-attr">properties</span>: properties })
}

</pre></div></div>

        </li>


        <li id="section-22">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Enqueue a user message into the <code>Islander</code>. The <code>Islander</code> will submit the
message, monitor the atomic log, and then resubmit the message if it detects
that the message was lost.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype.publish = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
    <span class="hljs-keyword">this</span>.play(<span class="hljs-string">'publish'</span>, entry)
}

</pre></div></div>

        </li>


        <li id="section-23">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Called by your network implementation with messages enqueued from another
Kibitz.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype.request = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, envelope</span>) </span>{
    <span class="hljs-keyword">switch</span> (envelope.method) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'immigrate'</span>:
        <span class="hljs-keyword">this</span>._immigrate(envelope.body, <span class="hljs-keyword">async</span>())
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'receive'</span>:
        <span class="hljs-keyword">return</span> [ <span class="hljs-keyword">this</span>.play(<span class="hljs-string">'receive'</span>, envelope.body) ]
    <span class="hljs-keyword">case</span> <span class="hljs-string">'enqueue'</span>:
        <span class="hljs-keyword">return</span> [ <span class="hljs-keyword">this</span>.play(<span class="hljs-string">'enqueue'</span>, envelope.body) ]
    }
})

Kibitzer.prototype.play = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">method, body</span>) </span>{
    <span class="hljs-keyword">var</span> envelope = {
        <span class="hljs-attr">module</span>: <span class="hljs-string">'kibitz'</span>,
        <span class="hljs-attr">method</span>: method,
        <span class="hljs-attr">when</span>: <span class="hljs-keyword">this</span>._Date.now(),
        <span class="hljs-attr">body</span>: body
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.replay(envelope)
}


Kibitzer.prototype.replay = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">envelope</span>) </span>{
    <span class="hljs-keyword">this</span>.played.push(envelope)
    <span class="hljs-keyword">switch</span> (envelope.method) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'bootstrap'</span>:
        <span class="hljs-keyword">this</span>.paxos.republic = envelope.body.republic
        <span class="hljs-keyword">this</span>.paxos.bootstrap(envelope.when, envelope.body.properties)
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'join'</span>:
        <span class="hljs-keyword">this</span>.paxos.cookie = envelope.when
        <span class="hljs-keyword">this</span>.paxos.republic = envelope.body.republic
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'naturalize'</span>:
        <span class="hljs-keyword">this</span>.paxos.naturalize()
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'event'</span>:
        <span class="hljs-keyword">this</span>.paxos.event(envelope.body)
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'immigrate'</span>:
        <span class="hljs-keyword">var</span> body = envelope.body
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.paxos.immigrate(envelope.when, body.republic, body.id, body.cookie, body.properties)
    <span class="hljs-keyword">case</span> <span class="hljs-string">'receive'</span>:
</pre></div></div>

        </li>


        <li id="section-24">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>TODO Split pulse from messages somehow, make them siblings, not nested.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.paxos.request(envelope.when, envelope.body)
    <span class="hljs-keyword">case</span> <span class="hljs-string">'enqueue'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>._enqueue(envelope.when, envelope.body)
    <span class="hljs-keyword">case</span> <span class="hljs-string">'publish'</span>:
        <span class="hljs-keyword">this</span>.islander.publish(envelope.body)
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'published'</span>:
        <span class="hljs-keyword">this</span>.islander.sent(envelope.body.cookie, envelope.body.promises)
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'sent'</span>:
        <span class="hljs-keyword">this</span>.paxos.response(envelope.when, envelope.body.cookie, envelope.body.responses)
        <span class="hljs-keyword">break</span>
    }
}

</pre></div></div>

        </li>


        <li id="section-25">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Stop timers, and stop timers only. We’re not in a position to notify clients
that there will be no more messages.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype.destroy = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>._destructible.destroy()
}

</pre></div></div>

        </li>


        <li id="section-26">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>TODO You are assuming that an address is not an address but a set of
properties, so you need to provide those properties for leader as an
argument, not just a url or identifier.</p>

            </div>

        </li>


        <li id="section-27">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype.join = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, republic, leader, properties</span>) </span>{
</pre></div></div>

        </li>


        <li id="section-28">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>TODO Should this be or should this not be? It should be. You’re sending your
enqueue messages until you immigrate. You don’t know when that will be.
You’re only going to know if you’ve succeeded if your legislator has
immigrated. That’s the only way.</p>

            </div>

        </li>


        <li id="section-29">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>TODO Was a test, but it is now an assertion and it really ought be an
exception because it is not impossible.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.paxos.government.promise != <span class="hljs-string">'0/0'</span>) {
        <span class="hljs-keyword">return</span>
    }

    assert(republic != <span class="hljs-literal">null</span>)

</pre></div></div>

        </li>


        <li id="section-30">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>throw new Error</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.play(<span class="hljs-string">'join'</span>, { <span class="hljs-attr">republic</span>: republic })
</pre></div></div>

        </li>


        <li id="section-31">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Note that we’re passing properties so that they’re logged for
inspection during debugging replay, but they’re not going to be used
as an argument to Paxos on this side. We give them to our leader when
we request immigration.</p>

            </div>

            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">this</span>._caller.invoke({
            <span class="hljs-attr">module</span>: <span class="hljs-string">'kibitz'</span>,
            <span class="hljs-attr">method</span>: <span class="hljs-string">'immigrate'</span>,
            <span class="hljs-attr">to</span>: leader,
            <span class="hljs-attr">body</span>: {
                <span class="hljs-attr">republic</span>: <span class="hljs-keyword">this</span>.paxos.republic,
                <span class="hljs-attr">id</span>: <span class="hljs-keyword">this</span>.paxos.id,
                <span class="hljs-attr">cookie</span>: <span class="hljs-keyword">this</span>.paxos.cookie,
                <span class="hljs-attr">properties</span>: properties,
                <span class="hljs-attr">hops</span>: <span class="hljs-number">0</span>
            }
        }, <span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{
        <span class="hljs-keyword">return</span> response != <span class="hljs-literal">null</span> &amp;&amp; response.enqueued
    })
})

Kibitzer.prototype.naturalize = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">this</span>.play(<span class="hljs-string">'naturalize'</span>, {})
}

</pre></div></div>

        </li>


        <li id="section-32">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Publish to consensus algorithm from islander retryable client.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype._publish = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    <span class="hljs-keyword">var</span> loop = <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._shifters.islander.dequeue(<span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">envelope</span>) </span>{
        <span class="hljs-keyword">if</span> (envelope == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> [ loop.break ]
        }
        <span class="hljs-keyword">async</span>([<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> properties = <span class="hljs-keyword">this</span>.paxos.government.properties[<span class="hljs-keyword">this</span>.paxos.government.majority[<span class="hljs-number">0</span>]]
            <span class="hljs-keyword">this</span>._caller.invoke({
                <span class="hljs-attr">module</span>: <span class="hljs-string">'kibitz'</span>,
                <span class="hljs-attr">method</span>: <span class="hljs-string">'enqueue'</span>,
                <span class="hljs-attr">to</span>: properties,
                <span class="hljs-attr">body</span>: {
                    <span class="hljs-attr">republic</span>: <span class="hljs-keyword">this</span>.paxos.republic,
                    <span class="hljs-attr">entries</span>: envelope.messages
                }
            }, <span class="hljs-keyword">async</span>())
        }, rescue(<span class="hljs-regexp">/^conduit#endOfStream$/m</span>, <span class="hljs-literal">null</span>)], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">promises</span>) </span>{
            <span class="hljs-keyword">this</span>.play(<span class="hljs-string">'published'</span>, { <span class="hljs-attr">cookie</span>: envelope.cookie, <span class="hljs-attr">promises</span>: promises })
        })
    })()
})

</pre></div></div>

        </li>


        <li id="section-33">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>TODO Annoying how difficult it is to stop this crazy thing. There are going
to be race conditions where we have a termination, come in, we shut things
down, but then we continue with processing a pulse which triggers a timer.
Sending messages to paxos can restart it’s scheduler.</p>
<p>TODO We could kill the timer in the scheduler, set the boolean we added to
tell it to no longer schedule.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype._send = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    <span class="hljs-keyword">var</span> loop = <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._shifters.paxos.dequeue(<span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">communique</span>) </span>{
        <span class="hljs-keyword">if</span> (communique == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> [ loop.break ]
        }
        <span class="hljs-keyword">var</span> responses = {}
        <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            communique.envelopes.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">envelope</span>) </span>{
                <span class="hljs-keyword">async</span>([<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                    <span class="hljs-keyword">this</span>._caller.invoke({
                        <span class="hljs-attr">module</span>: <span class="hljs-string">'kibitz'</span>,
                        <span class="hljs-attr">method</span>: <span class="hljs-string">'receive'</span>,
                        <span class="hljs-attr">to</span>: envelope.properties,
                        <span class="hljs-attr">body</span>: envelope.request
                    }, <span class="hljs-keyword">async</span>())
                }, rescue(<span class="hljs-regexp">/^conduit#endOfStream$/m</span>, <span class="hljs-literal">null</span>)], <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{
                    communique.responses[envelope.to] = response
                })
            }, <span class="hljs-keyword">this</span>)
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">this</span>.play(<span class="hljs-string">'sent'</span>, { <span class="hljs-attr">cookie</span>: communique.cookie, <span class="hljs-attr">responses</span>: communique.responses })
        })
    })()
})

</pre></div></div>

        </li>


        <li id="section-34">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>TODO Hopping is a second way of doing a thing and we don’t need a second way
of doing a thing.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype._immigrate = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, post</span>) </span>{
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        assert(post.hops != <span class="hljs-literal">null</span>)
        <span class="hljs-keyword">var</span> outcome = <span class="hljs-keyword">this</span>.play(<span class="hljs-string">'immigrate'</span>, post)
        <span class="hljs-keyword">return</span> outcome
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">outcome</span>) </span>{
        <span class="hljs-keyword">if</span> (!outcome.enqueued &amp;&amp; outcome.leader != <span class="hljs-literal">null</span> &amp;&amp; post.hops == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">var</span> properties = <span class="hljs-keyword">this</span>.paxos.government.properties[outcome.leader]
            post.hops++
            <span class="hljs-keyword">this</span>._caller.invoke({
                <span class="hljs-attr">module</span>: <span class="hljs-string">'kibtiz'</span>,
                <span class="hljs-attr">method</span>: <span class="hljs-string">'immigrate'</span>,
                <span class="hljs-attr">to</span>: properties,
                <span class="hljs-attr">body</span>: post
            }, <span class="hljs-keyword">async</span>())
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> [ outcome ]
        }
    })
})

Kibitzer.prototype._enqueue = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">when, post</span>) </span>{
    <span class="hljs-keyword">var</span> promises = {}
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = post.entries.length; i &lt; I; i++) {
        <span class="hljs-keyword">var</span> entry = post.entries[i]
        <span class="hljs-keyword">var</span> outcome = <span class="hljs-keyword">this</span>.paxos.enqueue(when, post.republic, entry)
        <span class="hljs-keyword">if</span> (!outcome.enqueued) {
            promises = <span class="hljs-literal">null</span>
            <span class="hljs-keyword">break</span>
        }
        promises[entry.cookie] = outcome.promise
    }
    <span class="hljs-keyword">return</span> promises
}

<span class="hljs-built_in">module</span>.exports = Kibitzer

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
