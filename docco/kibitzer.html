<!DOCTYPE html>

<html>
<head>
  <title>kibitzer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>kibitzer.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>TODO I suppose my attitude is to use an event emitter very sparingly, because
I want to use one to emit Kibitzer events, the paxos log, but I don’t want to
create an interface that looks like one of the EventEmitter heavy interfaces.</p>
<p>One of the challenges here is that events are going to flow immediately,
unless I do something compliacated like only emit events when there is a
listener. Having looked at that, it is not actually that complicated.</p>
<p>Now we can fuss about some terminate logic.</p>
<p>Put it out again, I prefer to program with error-first callbacks, but events
happen. They are generally a way in which information enters the system. They
are synchronous. Here is more information. Generally, they shouldn’t block.</p>
<p>That’s how I use EventEmitters, but I’m not in for a penny, in for a pound.
If there is a source of events, I treat that as a stream of events. Not in
the Node.js streams sense, but I create an event emitter that emits a
homogenous series of events terminated by a specific termination event.</p>
<p>Then I stop. I don’t go on to implement multi-interfaces that could take an
error-first callback, or maybe register an event handler, or maybe use some
other form of asynchronous notification.</p>
<p>TODO Which is why I’ve made the event emitter in this class a separate
object. Which is such a good idea, I belive I’ll go and do it Happenstance.</p>
<p>TODO Here I am, back to remove the EventEmitter. Not sure how anyone is able
to program that way, treating everything in your application as a stream.
Pushing log entires as events, hard to reason about this firehose events, and
it makes any asynchronous calls in response to an event require subsequen
queuing of events, so why not use this queue that already exists?</p>

            </div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Quality control.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>)
<span class="hljs-keyword">var</span> events = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>)

</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Varadic arguments.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> slice = [].slice

</pre></div></div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Control-flow libraries.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> abend = <span class="hljs-built_in">require</span>(<span class="hljs-string">'abend'</span>)
<span class="hljs-keyword">var</span> cadence = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cadence'</span>)
<span class="hljs-keyword">var</span> Reactor = <span class="hljs-built_in">require</span>(<span class="hljs-string">'reactor'</span>)
<span class="hljs-keyword">var</span> Scheduler = <span class="hljs-built_in">require</span>(<span class="hljs-string">'happenstance'</span>)
<span class="hljs-keyword">var</span> Vestibule = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vestibule'</span>)

</pre></div></div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Paxos libraries.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Legislator = <span class="hljs-built_in">require</span>(<span class="hljs-string">'paxos/legislator'</span>)
<span class="hljs-keyword">var</span> Islander = <span class="hljs-built_in">require</span>(<span class="hljs-string">'islander'</span>)
<span class="hljs-keyword">var</span> Monotonic = <span class="hljs-built_in">require</span>(<span class="hljs-string">'monotonic'</span>).asString

</pre></div></div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Logging.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">'prolific.logger'</span>).createLogger(<span class="hljs-string">'kibitz'</span>)

</pre></div></div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>The <code>Kibitzer</code> object contains an islander, which will submit messages to
Paxos, track the log generated by Paxos and resubit any messages that migh
have been dropped.</p>

            </div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Kibitzer</span> (<span class="hljs-params">islandId, id, options</span>) </span>{
</pre></div></div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Set option defaults.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    options || (options = {})

    options.ping || (options.ping = <span class="hljs-number">250</span>)
    options.timeout || (options.timeout = <span class="hljs-number">1000</span>)

</pre></div></div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The HTTP user agent is provided so it can mocked for testing.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._ua = options.ua

</pre></div></div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>TODO How are these properties used? It seems like there is a properties
object at every level of abstraction. I’d expect the properties object in
Paxos to be the definitive properties mechanism. They should be set with
an accessor to record the property setting.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.properties = options.properties

</pre></div></div>

        </li>


        <li id="section-12">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Queues for Paxos messages to send and user messages to submit to Paxos.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._sender = <span class="hljs-keyword">new</span> Reactor({ object: <span class="hljs-keyword">this</span>, method: <span class="hljs-string">'_send'</span> })
    <span class="hljs-keyword">this</span>._publisher = <span class="hljs-keyword">new</span> Reactor({ object: <span class="hljs-keyword">this</span>, method: <span class="hljs-string">'_publish'</span> })

</pre></div></div>

        </li>


        <li id="section-13">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Time obtained from optional <code>Date</code> for unit testing.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._Date = options.Date || <span class="hljs-built_in">Date</span>
    <span class="hljs-keyword">this</span>.scheduler = <span class="hljs-keyword">new</span> Scheduler({ <span class="hljs-built_in">Date</span>: <span class="hljs-keyword">this</span>._Date })

    <span class="hljs-keyword">this</span>.legislator = <span class="hljs-keyword">new</span> Legislator(islandId, id, options.cookie || <span class="hljs-keyword">this</span>._Date.now(), {
        ping: options.ping,
        timeout: options.timeout,
        scheduler: {
            <span class="hljs-built_in">Date</span>: options.Date || <span class="hljs-built_in">Date</span>,
            timerless: options.timerless || <span class="hljs-literal">false</span>
        }
    })

</pre></div></div>

        </li>


        <li id="section-14">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>TODO Scheduler is not shutting down, so maybe <code>unref</code> for now.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.legislator.scheduler.on(<span class="hljs-string">'timeout'</span>, <span class="hljs-keyword">this</span>._checkOutbox.bind(<span class="hljs-keyword">this</span>))

</pre></div></div>

        </li>


        <li id="section-15">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Submission queue with resubmission logic.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.islander = <span class="hljs-keyword">new</span> Islander(<span class="hljs-keyword">this</span>.legislator.id)

</pre></div></div>

        </li>


        <li id="section-16">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Iterators to advance through both the Paxos and Islander message logs.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.iterators = {
        legislator: <span class="hljs-keyword">this</span>.legislator.log.min(),
        islander: { dummy: <span class="hljs-literal">true</span> }
    }

</pre></div></div>

        </li>


        <li id="section-17">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>TODO Very much crufty.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.log = <span class="hljs-keyword">new</span> events.EventEmitter
    <span class="hljs-keyword">this</span>.log.on(<span class="hljs-string">'newListener'</span>, <span class="hljs-keyword">this</span>._newLogListener.bind(<span class="hljs-keyword">this</span>))

    <span class="hljs-keyword">this</span>._advanced = <span class="hljs-keyword">new</span> Vestibule

</pre></div></div>

        </li>


        <li id="section-18">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>More crufty, but not terribly crufty.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._terminated = <span class="hljs-literal">false</span>

</pre></div></div>

        </li>


        <li id="section-19">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Used to record events generated during playback.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>._recording = { paxos: [], islander: [] }
}

</pre></div></div>

        </li>


        <li id="section-20">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>We record events generated during playback so that they can be compared with
the actual events played back from the log to assert that the playback is
indeed determinic.</p>

            </div>

        </li>


        <li id="section-21">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>

            </div>

        </li>


        <li id="section-22">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Put the Kibitzer in a replay state. TODO Maybe move this into the
constructor, or better still, use a decorator pattern.</p>

            </div>

        </li>


        <li id="section-23">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype.replay = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre></div></div>

        </li>


        <li id="section-24">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>TODO Can Prolific Logger support this pattern? TODO Actually, just patch over
the <code>Writer</code> with a decorator, document the example as the way to do it. The
writer is passive, you should only be setting it up in a program, during
program startup, prior to any logging. There ought to be no logging during
<code>require</code>, but if there is, then you need to concern yourself with the order
of require, and that okay, if you’ve got that edge case for true.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.legislator._trace = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">method, vargs</span>) </span>{
        <span class="hljs-keyword">this</span>._recording.paxos.push({ method: method, vargs: <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify(vargs)) })
    }.bind(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">this</span>.islander._trace = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">method, vargs</span>) </span>{
        <span class="hljs-keyword">this</span>._recording.islander.push({ method: method, vargs: <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-built_in">JSON</span>.stringify(vargs)) })
    }.bind(<span class="hljs-keyword">this</span>)
    <span class="hljs-keyword">this</span>._prime(abend)
}

</pre></div></div>

        </li>


        <li id="section-25">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Play an entry in the playback log.</p>

            </div>

        </li>


        <li id="section-26">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype.play = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
    <span class="hljs-keyword">if</span> (entry.qualifier == <span class="hljs-string">'paxos'</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._recording.paxos.length) {
            assert.deepEqual(<span class="hljs-keyword">this</span>._recording.paxos.shift(), {
                method: entry.name,
                vargs: entry.$vargs
            })
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.legislator[entry.name].apply(<span class="hljs-keyword">this</span>.legislator, entry.$vargs)
            <span class="hljs-keyword">this</span>._advanced.notify()
            <span class="hljs-keyword">this</span>.play(entry)
        }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (entry.qualifier == <span class="hljs-string">'islander'</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._recording.islander.length) {
            assert.deepEqual(<span class="hljs-keyword">this</span>._recording.islander.shift(), {
                method: entry.name,
                vargs: entry.$vargs
            })
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.islander[entry.name].apply(<span class="hljs-keyword">this</span>.islander, entry.$vargs)
            <span class="hljs-keyword">this</span>.play(entry)
        }
    }
}

Kibitzer.prototype.bootstrap = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    <span class="hljs-keyword">this</span>._logger(<span class="hljs-string">'info'</span>, <span class="hljs-string">'bootstrap'</span>, { kibitzerId: <span class="hljs-keyword">this</span>.legislator.id })
    <span class="hljs-keyword">this</span>._prime(<span class="hljs-keyword">async</span>())
    <span class="hljs-keyword">this</span>.legislator.bootstrap(<span class="hljs-keyword">this</span>._Date.now(), <span class="hljs-keyword">this</span>.properties)
    <span class="hljs-keyword">this</span>._checkOutbox()
})

</pre></div></div>

        </li>


        <li id="section-27">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>TODO Use Isochronous to repeatedly send join message.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype.join = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, properties</span>) </span>{
    assert(<span class="hljs-keyword">typeof</span> properties == <span class="hljs-string">'object'</span>)
    <span class="hljs-keyword">this</span>._prime(<span class="hljs-keyword">async</span>())
    <span class="hljs-keyword">this</span>.scheduler.schedule(<span class="hljs-keyword">this</span>._Date.now() + <span class="hljs-number">0</span>, <span class="hljs-string">'join'</span>, { object: <span class="hljs-keyword">this</span>, method: <span class="hljs-string">'_checkJoin'</span> }, properties)
})

</pre></div></div>

        </li>


        <li id="section-28">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Enqueue a user message into the <code>Islander</code>. The <code>Islander</code> will submit the
message, monitor the atomic log, and then resubmit the message if it detects
that the message was lost.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype.publish = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">entry</span>) </span>{
    <span class="hljs-keyword">var</span> cookie = <span class="hljs-keyword">this</span>.islander.publish(entry, <span class="hljs-literal">false</span>)
    logger.info(<span class="hljs-string">'publish'</span>, { $entry: entry, cookie: cookie })
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.scheduler.scheduled(<span class="hljs-string">'publish'</span>) == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">this</span>.scheduler.schedule(<span class="hljs-number">0</span>, <span class="hljs-string">'publish'</span>, { object: <span class="hljs-keyword">this</span>, method: <span class="hljs-string">'_checkPublisher'</span> })
    }
    <span class="hljs-keyword">return</span> cookie
}

</pre></div></div>

        </li>


        <li id="section-29">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Called by your network implementation with messages enqueued from another
Kibitz.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype.dispatch = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, body</span>) </span>{
    <span class="hljs-keyword">switch</span> (body.type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'immigrate'</span>:
        <span class="hljs-keyword">this</span>._naturalize(body, <span class="hljs-keyword">async</span>())
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'receive'</span>:
        <span class="hljs-keyword">this</span>._receive(body.pulse, <span class="hljs-keyword">async</span>())
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'enqueue'</span>:
        <span class="hljs-keyword">this</span>._enqueue(body, <span class="hljs-keyword">async</span>())
        <span class="hljs-keyword">break</span>
    }
})

</pre></div></div>

        </li>


        <li id="section-30">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Stop timers. TODO Is this being called from Colleague?</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype.terminate = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._terminated) {
        <span class="hljs-keyword">this</span>._terminated = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">this</span>.scheduler.shutdown()
        <span class="hljs-keyword">this</span>.legislator.scheduler.shutdown()
        <span class="hljs-keyword">this</span>._advanced.notify()
    }
}

</pre></div></div>

        </li>


        <li id="section-31">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>TODO Priming is no longer necessary with pull interface.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype._prime = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> loop = <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">this</span>._advanced.enter(<span class="hljs-keyword">async</span>())
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.iterators.legislator.next != <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">this</span>.iterators.legislator = <span class="hljs-keyword">this</span>.iterators.legislator.nex
                    <span class="hljs-keyword">this</span>.iterators.islander = {
                        next: <span class="hljs-keyword">this</span>.islander.prime(<span class="hljs-keyword">this</span>.iterators.legislator)
                    }
                    <span class="hljs-keyword">return</span> [ loop.break ]
                }
            })
        })()
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._advance(abend)
    })
})

</pre></div></div>

        </li>


        <li id="section-32">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>When we join we repeatedly submit a immigration request until we know tha
we’ve immigrated.</p>

            </div>

        </li>


        <li id="section-33">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Invoked periodically by the scheduler to see if immigration was successful,
resubmit if it was not successful.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype._checkJoin = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">when, properties</span>) </span>{
    <span class="hljs-keyword">this</span>._join(properties, abend)
}

</pre></div></div>

        </li>


        <li id="section-34">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>TODO Join with initial properties. Implement the concept of an introduction
in Colleague.</p>

            </div>

        </li>


        <li id="section-35">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype._join = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, properties</span>) </span>{
</pre></div></div>

        </li>


        <li id="section-36">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>TODO Should this be or should this not be? It should be. You’re sending your
enqueue messages until you immigrate. You don’t know when that will be.
You’re only going to know if you’ve succeeded if your legislator has
immigrated. That’s the only way.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.legislator.government.promise != <span class="hljs-string">'0/0'</span>) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Hey! I got a government.'</span>)
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._logger(<span class="hljs-string">'info'</span>, <span class="hljs-string">'join'</span>, {
            kibitzerId: <span class="hljs-keyword">this</span>.legislator.id,
            received: <span class="hljs-built_in">JSON</span>.stringify(properties)
        })
        <span class="hljs-keyword">this</span>._ua.send(properties, {
            type: <span class="hljs-string">'immigrate'</span>,
            islandId: <span class="hljs-keyword">this</span>.legislator.islandId,
            id: <span class="hljs-keyword">this</span>.legislator.id,
            cookie: <span class="hljs-keyword">this</span>.legislator.cookie,
            properties: <span class="hljs-keyword">this</span>.properties,
            hops: <span class="hljs-number">0</span>
        }, <span class="hljs-keyword">async</span>())
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{
        <span class="hljs-keyword">if</span> (response == <span class="hljs-literal">null</span> || !response.enqueued) {
            <span class="hljs-keyword">var</span> delay = <span class="hljs-keyword">this</span>._Date.now() + <span class="hljs-number">1000</span>
            <span class="hljs-keyword">this</span>.scheduler.schedule(delay, <span class="hljs-string">'join'</span>, { object: <span class="hljs-keyword">this</span>, method: <span class="hljs-string">'_checkJoin'</span> }, properties)
        }
    })
})

</pre></div></div>

        </li>


        <li id="section-37">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>TODO Wierd but scheduler calls us with a timing, so that is interpreted as
the callback to <code>check</code>. Could spend all day trying to decide if that’s a
correct use of <code>Operation</code>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype._checkPublisher = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    logger.info(<span class="hljs-string">'_checkPublisher'</span>, { publisher: <span class="hljs-keyword">this</span>._publisher.turnstile.health })
    <span class="hljs-keyword">this</span>._publisher.check()
}

</pre></div></div>

        </li>


        <li id="section-38">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Internal publishing.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype._publish = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    <span class="hljs-keyword">var</span> loop = <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> outgoing = <span class="hljs-keyword">this</span>.islander.outbox()
        logger.info(<span class="hljs-string">'_publish'</span>, { $outgoing: outgoing, $sent: <span class="hljs-keyword">this</span>.islander.sent.ordered })
        <span class="hljs-keyword">if</span> (outgoing.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> [ loop.break ]
        }
        <span class="hljs-keyword">var</span> pos
        <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> properties = <span class="hljs-keyword">this</span>.legislator.properties[<span class="hljs-keyword">this</span>.legislator.government.majority[<span class="hljs-number">0</span>]]
            <span class="hljs-keyword">this</span>._ua.send(properties, post = {
                islandId: <span class="hljs-keyword">this</span>.legislator.islandId,
                type: <span class="hljs-string">'enqueue'</span>,
                entries: outgoing
            }, <span class="hljs-keyword">async</span>())
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">body</span>) </span>{
            <span class="hljs-keyword">this</span>._logger(<span class="hljs-string">'info'</span>, <span class="hljs-string">'enqueued'</span>, {
                kibitzerId: <span class="hljs-keyword">this</span>.legislator.id,
                sent: post,
                received: body
            })
            <span class="hljs-keyword">if</span> (body == <span class="hljs-literal">null</span>) {
                body = { entries: [] }
            }
            <span class="hljs-keyword">this</span>.islander.published(body.entries)
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.iterators.islander.next) {
                <span class="hljs-keyword">this</span>._advanced.notify()
            }
        })
    })()
})

</pre></div></div>

        </li>


        <li id="section-39">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>TODO Annoying how difficult it is to stop this crazy thing. There are going
to be race conditions where we have a termination, come in, we shut things
down, but then we continue with processing a pulse which triggers a timer.
Sending messages to legislator can restart it’s scheduler.</p>
<p>TODO We could kill the timer in the scheduler, set the boolean we added to
tell it to no longer schedule.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype._send = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, timeout, pulse</span>) </span>{
    <span class="hljs-keyword">var</span> responses = {}
    <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">async</span>.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">id</span>) </span>{
            <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span> (id == <span class="hljs-keyword">this</span>.legislator.id) {
                    <span class="hljs-keyword">this</span>._receive(pulse, <span class="hljs-keyword">async</span>())
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">var</span> properties = <span class="hljs-keyword">this</span>.legislator.properties[id]
                    <span class="hljs-keyword">this</span>._ua.send(properties, {
                        type: <span class="hljs-string">'receive'</span>,
                        pulse: pulse
                    }, <span class="hljs-keyword">async</span>())
                }
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{
                <span class="hljs-keyword">this</span>._logger(<span class="hljs-string">'info'</span>, <span class="hljs-string">'published'</span>, {
                    kibitzerId: <span class="hljs-keyword">this</span>.legislator.id,
                    sent: pulse,
                    received: response
                })
                responses[id] = response
            })
        })(pulse.route)
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>.legislator.sent(<span class="hljs-keyword">this</span>._Date.now(), pulse, responses)
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.iterators.legislator.next != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">this</span>._advanced.notify()
        }
    }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">this</span>._checkOutbox()
    })
})

Kibitzer.prototype._checkOutbox = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> now = <span class="hljs-keyword">this</span>._Date.now()
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-keyword">var</span> outbox = <span class="hljs-keyword">this</span>.legislator.synchronize(now)
        <span class="hljs-keyword">if</span> (outbox.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">var</span> consensus = <span class="hljs-keyword">this</span>.legislator.consensus(now)
            <span class="hljs-keyword">if</span> (consensus != <span class="hljs-literal">null</span>) {
                outbox.push(consensus)
            }
        }
        <span class="hljs-keyword">if</span> (outbox.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">break</span>
        }
        outbox.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">pulse</span>) </span>{
            <span class="hljs-keyword">this</span>._sender.push(pulse)
        }, <span class="hljs-keyword">this</span>)
    }
}

Kibitzer.prototype._naturalize = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, post</span>) </span>{
    assert(post.hops != <span class="hljs-literal">null</span>)
    <span class="hljs-keyword">var</span> outcome = <span class="hljs-keyword">this</span>.legislator.immigrate(<span class="hljs-keyword">this</span>._Date.now(), post.islandId, post.id, post.cookie, post.properties)
    <span class="hljs-keyword">this</span>._logger(<span class="hljs-string">'info'</span>, <span class="hljs-string">'enqueue'</span>, {
        kibitzerId: <span class="hljs-keyword">this</span>.legislator.id,
        received: <span class="hljs-built_in">JSON</span>.stringify(post),
        outcome: <span class="hljs-built_in">JSON</span>.stringify(outcome)
    })
    <span class="hljs-keyword">if</span> (!outcome.enqueued &amp;&amp; outcome.leader != <span class="hljs-literal">null</span> &amp;&amp; post.hops == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">var</span> properties = <span class="hljs-keyword">this</span>.legislator.properties[<span class="hljs-keyword">this</span>.legislator.government.majority[<span class="hljs-number">0</span>]]
        post.hops++
        <span class="hljs-keyword">this</span>._ua.send(properties, post, <span class="hljs-keyword">async</span>())
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>._checkOutbox()
        <span class="hljs-keyword">return</span> [ outcome ]
    }
})

Kibitzer.prototype._enqueue = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, post</span>) </span>{
    <span class="hljs-keyword">var</span> response = { posted: <span class="hljs-literal">false</span>, entries: [] }
</pre></div></div>

        </li>


        <li id="section-40">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>TODO Redirect enqueue or wait for stability and retry.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = post.entries.length; i &lt; I; i++) {
        <span class="hljs-keyword">var</span> entry = post.entries[i]
        <span class="hljs-keyword">var</span> outcome = <span class="hljs-keyword">this</span>.legislator.enqueue(<span class="hljs-keyword">this</span>._Date.now(), post.islandId, entry)
        <span class="hljs-keyword">if</span> (!outcome.enqueued) {
            response.entries.length = <span class="hljs-number">0</span>
            <span class="hljs-keyword">break</span>
        }
        response.entries.push({ cookie: entry.cookie, promise: outcome.promise })
    }
    <span class="hljs-keyword">this</span>._checkOutbox()
    <span class="hljs-keyword">this</span>._logger(<span class="hljs-string">'info'</span>, <span class="hljs-string">'enqueue'</span>, {
        kibitzerId: <span class="hljs-keyword">this</span>.legislator.id,
        received: <span class="hljs-built_in">JSON</span>.stringify(post),
        sent: <span class="hljs-built_in">JSON</span>.stringify(response)
    })
    <span class="hljs-keyword">return</span> response
})

Kibitzer.prototype._receive = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async, pulse</span>) </span>{
    <span class="hljs-keyword">this</span>._logger(<span class="hljs-string">'info'</span>, <span class="hljs-string">'receive'</span>, {
        kibitzerId: <span class="hljs-keyword">this</span>.legislator.id,
        received: pulse
    })
    <span class="hljs-keyword">var</span> ret = [ <span class="hljs-keyword">this</span>.legislator.receive(<span class="hljs-keyword">this</span>._Date.now(), pulse, pulse.messages) ]
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.iterators.legislator.next != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">this</span>._advanced.notify()
    }
    <span class="hljs-keyword">this</span>._checkOutbox()
    <span class="hljs-keyword">this</span>._checkPublisher()
    <span class="hljs-keyword">return</span> re
})

Kibitzer.prototype._advance = cadence(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">async</span>) </span>{
    <span class="hljs-keyword">var</span> loop = <span class="hljs-keyword">async</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>._terminated) {
            <span class="hljs-keyword">this</span>.log.emit(<span class="hljs-string">'terminated'</span>)
            <span class="hljs-keyword">return</span> [ loop.break ]
        }
        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.iterators.legislator.next != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">this</span>.iterators.legislator = <span class="hljs-keyword">this</span>.iterators.legislator.nex
            <span class="hljs-keyword">this</span>._logger(<span class="hljs-string">'info'</span>, <span class="hljs-string">'consuming'</span>, {
                kibitzerId: <span class="hljs-keyword">this</span>.legislator.id,
                route: <span class="hljs-keyword">this</span>.iterators.legislator.route,
                promise: <span class="hljs-keyword">this</span>.iterators.legislator.promise,
                value: <span class="hljs-keyword">this</span>.iterators.legislator.value
            })
            <span class="hljs-keyword">this</span>.islander.receive([ <span class="hljs-keyword">this</span>.iterators.legislator ])
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.log.listenerCount(<span class="hljs-string">'entry'</span>) == <span class="hljs-number">0</span> || <span class="hljs-keyword">this</span>.iterators.islander.next == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">this</span>._advanced.enter(<span class="hljs-keyword">async</span>())
        } <span class="hljs-keyword">else</span> {
</pre></div></div>

        </li>


        <li id="section-41">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>TODO Think hard about how messy this has become.
TODO Maybe header and body and the header is used internallyish? Islander would use it.</p>

            </div>

            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> entry = <span class="hljs-keyword">this</span>.iterators.islander = <span class="hljs-keyword">this</span>.iterators.islander.nex
            <span class="hljs-keyword">var</span> government = Monotonic.isBoundary(entry.promise, <span class="hljs-number">0</span>)
            <span class="hljs-keyword">var</span> value = government ? entry.value : entry.value.value
            <span class="hljs-keyword">this</span>.log.emit(<span class="hljs-string">'entry'</span>, {
                government: government,
                promise: entry.promise,
                value: value
            })
        }
    })()
})

</pre></div></div>

        </li>


        <li id="section-42">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>TODO Outgoing.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype._newLogListener = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    setImmediate(<span class="hljs-keyword">this</span>._advanced.notify.bind(<span class="hljs-keyword">this</span>._advanced))
}

</pre></div></div>

        </li>


        <li id="section-43">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>TODO Replace with <code>logger.sink.writer</code> decorator.</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype._logger = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">level, message, context</span>) </span>{
    logger[level](message, context)
}

</pre></div></div>

        </li>


        <li id="section-44">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>TODO Where is this being used? Why not just reference the Legislators
properties directly?</p>

            </div>

            <div class="content"><div class='highlight'><pre>Kibitzer.prototype.getProperties = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> properties = []
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.legislator.properties) {
        properties.push(<span class="hljs-keyword">this</span>.legislator.properties[key])
    }
    <span class="hljs-keyword">return</span> properties
}

<span class="hljs-built_in">module</span>.exports = Kibitzer

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
